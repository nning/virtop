#!/usr/bin/env ruby

# Require uri module and print out exception message if it could not be loaded.
begin
	require( 'uri' )
rescue LoadError => e
	$stderr.puts( e.message )
	exit( 1 )
end

# Require ncurses module and print out instructions howto install it if it could
# not be loaded.
begin
	require 'ncurses'
rescue LoadError
	$stderr.puts <<EOF
The Ruby bindings to the ncurses library are missing. The ncurses gem on
rubygems.org is not working with Ruby 1.9, so please issue the following
commands as superuser to install a working ncurses gem from github.com:

  gem source -a http://gems.github.com
  gem install elliottcable-ncurses

EOF
	exit( 1 )
end

# Require and include virtop module. It will require libvirt.
$:.unshift( File.join( File.dirname( __FILE__ ), '../lib' ) )
require( 'virtop' )
include Virtop

# Connection URL will be qemu:///system if nothing else is given as the first
# parameter.
if( ARGV.size < 1 )
	url = 'qemu:///system'
else
	uri = URI.parse( ARGV.first )

	if( uri.scheme == 'qemu+ssh' and uri.path == '' )
		raise( Exception.new( 'invalid url specified' ) )
	else
		url = uri.to_s
	end
end

# Open the connection to the libvirt ressource or print out error message.
begin
	c = Libvirt::open( url )
rescue Libvirt::ConnectionError
	$stderr.puts( 'connection failed' )
	exit( 1 )
end

# Initialize ncurses context. Clear and print details for each domain in a 10s
# interval. Quit on keypress of 'q'.
begin
	n = Ncurses.initscr

	Ncurses.cbreak
	Ncurses.noecho
	Ncurses.halfdelay( 10 )

	while( true )
		Ncurses.clear

		n.intrflush( false )
		n.keypad( true )

		info = c.node_get_info

		n.addstr(
			c.hostname.upcase +
			"\n" +
			' cores ' + info.cores.to_s +
			' cpus '  + info.cpus.to_s +
			' mhz '   + info.mhz.to_s +
			' arch '  + info.model.to_s +
			"\n" +
			' mem '   + info.memory.to_s +
			' nodes ' + info.nodes.to_s +
			' sockets ' + info.sockets.to_s +
			' threads ' + info.threads.to_s +
			"\n" +
			' version ' + c.libversion.to_s +
			"\n\n"
		)

		t = Table.new(
			'NAME',
			'STATE',
			'MEM',
			'MEM_MAX',
			'CPU_NUM',
			'CPU_TIME'
		)

		c.domains.each do |d|
			t.add_row(
				d.name,
				d.state,
				d.mem,
				d.mem_max,
				d.cpu_num,
				d.cpu_time
			)
		end

		t.format.each do |line|
			n.addstr( line )
		end

		n.refresh

		raise( LetsExit ) if( n.getch == 113 )
	end
rescue LetsExit
ensure
	Ncurses.echo
	Ncurses.cbreak
	Ncurses.endwin
end
